@file:JvmName("GenerateInterfaces")

package com.twingineer.sysml.ref.gen

import com.github.ajalt.clikt.core.CliktCommand
import com.github.ajalt.clikt.parameters.options.option
import com.github.ajalt.clikt.parameters.options.required
import com.github.ajalt.clikt.parameters.types.path
import com.twingineer.ktemplar.appendTemplate
import com.twingineer.mof.parse.MofParseNode
import com.twingineer.mof.parse.asString
import com.twingineer.mof.parse.name
import com.twingineer.mof.parse.parseMof
import java.nio.file.Files
import java.nio.file.Path
import kotlin.io.path.writer
import com.twingineer.ktemplar.raw as java
import com.twingineer.sysml.ref.gen.GeneratorConstants as const

fun generateInterfaces(inputFile: Path, outputDir: Path) {
    parseMof(inputFile) {
        root["packagedElement"].elements()
            .forEach { packagedElement ->
                val name = packagedElement.name.asJavaClassName()
                when (packagedElement["type"].asString()) {
                    "uml:Class" -> {
                        outputDir.resolve("$name.java").writer().use { out ->
                            out.appendTemplate {
                                java(
                                    """
// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
package ${const.javaInterfacePackage};

import java.util.Collection;
import java.util.List;
import java.util.Set;

public interface ${packagedElement.name.asJavaClassName()} extends
"""
                                )
                                packagedElement.generals().forEach { general ->
                                    java(
                                        """
|${general.name.asJavaClassName()},
"""
                                    )
                                }
                                java(
                                    """
|SysMLType {
"""
                                )
                                if (packagedElement.has("ownedAttribute")) {
                                    packagedElement["ownedAttribute"].elements()
                                        .sortedBy(MofParseNode::name)
                                        .forEach { attribute ->
                                            if (attribute.redefinedProperty().map { it.dereference() }
                                                    .any { it.name == attribute.name })
                                                java(
                                                    """

|   @Override
"""
                                                )
                                            java(
                                                """

|   ${attributeAsJavaInterfaceTypeCounted(attribute)} get${
                                                    attribute.name.asJavaVariableName()
                                                        .replaceFirstChar(Char::uppercaseChar)
                                                }();

"""
                                            )
                                        }
                                }
                                java(
                                    """
}
"""
                                )
                            }
                        }
                    }

                    "uml:Enumeration" -> {
                        outputDir.resolve("$name.java").writer().use { out ->
                            out.appendTemplate {
                                java(
                                    """
package ${const.javaInterfacePackage};

import com.fasterxml.jackson.annotation.JsonProperty;

public enum $name {
"""
                                )
                                val ownedLiteralIter = packagedElement["ownedLiteral"].elements()
                                    .sortedBy(MofParseNode::name)
                                    .iterator()
                                while (ownedLiteralIter.hasNext()) {
                                    val literal = ownedLiteralIter.next()
                                    java(
                                        """

|   @JsonProperty("${literal.name}") ${literal.name.asJavaEnumLiteralName()}${if (ownedLiteralIter.hasNext()) "," else ""}
"""
                                    )
                                }
                                java(
                                    """

}
"""
                                )
                            }
                        }
                    }

                    else -> Unit
                }

            }
    }
}

class InterfaceGeneratorCli : CliktCommand() {
    private val input: Path by option()
        .path(mustExist = true, canBeFile = true, canBeDir = false, mustBeReadable = true)
        .required()
    private val output: Path by option()
        .path(mustExist = false, canBeFile = false, canBeDir = true)
        .required()

    override fun run() {
        Files.createDirectories(output)
        generateInterfaces(input, output)
    }
}

fun main(args: Array<String>) = InterfaceGeneratorCli().main(args)